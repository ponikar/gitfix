name: VibeRescue Scan

on:
  repository_dispatch:
    types: [run_scan]
  workflow_dispatch:

jobs:
  eslint-scan:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install ESLint deps (bun)
        run: |
          bun i && bun add eslint \
            @typescript-eslint/parser \
            eslint-plugin-security \
            eslint-plugin-react \
            eslint-plugin-react-hooks \
            eslint-plugin-import \
            eslint-plugin-no-unsanitized

      - name: Create ESLint flat config
        run: |
          cat <<EOF > eslint.config.js
          import tsParser from "@typescript-eslint/parser";
          import security from "eslint-plugin-security";
          import react from "eslint-plugin-react";
          import reactHooks from "eslint-plugin-react-hooks";
          import importPlugin from "eslint-plugin-import";
          import noUnsanitized from "eslint-plugin-no-unsanitized";

          export default [
            {
              files: ["**/*.{js,jsx,ts,tsx}"],
              languageOptions: {
                parser: tsParser,
                ecmaVersion: "latest",
                sourceType: "module"
              },
              plugins: {
                security,
                react,
                "react-hooks": reactHooks,
                import: importPlugin,
                "no-unsanitized": noUnsanitized
              },
              rules: {
                "security/detect-eval-with-expression": "error",
                "security/detect-object-injection": "warn",

                "react/no-danger": "error",
                "react-hooks/rules-of-hooks": "error",
                "react-hooks/exhaustive-deps": "warn",

                "no-unsanitized/method": "error",
                "no-unsanitized/property": "error",

                "import/no-dynamic-require": "warn"
              }
            }
          ];
          EOF

      - name: Run ESLint
        run: |
          bunx eslint . \
            --format json \
            > eslint-raw.json || true

      - name: Summarize ESLint results
        run: |
          jq '{
            issueCount: (map(.messages | length) | add),
            issues: [
              .[] | .filePath as $file
              | .messages[]
              | {
                  file: $file,
                  rule: .ruleId,
                  severity: .severity,
                  message: .message
                }
            ]
          }' eslint-raw.json > eslint-summary.json

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: viberescue-eslint
          path: eslint-summary.json
